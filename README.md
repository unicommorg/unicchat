# Инструкция по установке корпоративного мессенджера для общения и командной работы UnicChat

###### Версия 6-2.1.70, версия документа 1.7

## Оглавление
<!-- TOC -->
  * [Инструкция по установке корпоративного мессенджера для общения и командной работы UnicChat](#инструкция-по-установке-корпоративного-мессенджера-для-общения-и-командной-работы-unicchat)
    * [Оглавление](#оглавление)
    * [Архитектура установки](#архитектура-установки)
    * [Шаг 1. Подготовка окружения](#шаг-1-подготовка-окружения)
    * [Шаг 2. Клонирование репозитория](#шаг-2-клонирование-репозитория)
    * [Шаг 3. Внешние зависимости](#шаг-3-внешние-зависимости)
    * [Шаг 4. Проверка версии MongoDB](#шаг-4-проверка-версии-mongodb)
    * [Шаг 5. Настройка HTTPS](#шаг-5-настройка-https)
    * [Шаг 6. Обновление конфигурации](#шаг-6-обновление-конфигурации)
    * [Шаг 7. Запуск UnicChat](#шаг-7-запуск-unicchat)
    * [Шаг 8. Обновление настроек MongoDB](#шаг-8-обновление-настроек-mongodb)
    * [Шаг 9. Создание пользователя-администратора](#шаг-9-создание-пользователя-администратора)
    * [Шаг 10. Карта сетевых взаимодействий сервера](#шаг-10-карта-сетевых-взаимодействий-сервера)
    * [Частые проблемы при установке](#частые-проблемы-при-установке)
    * [Клиентские приложения](#клиентские-приложения)
<!-- TOC -->

## Архитектура установки

#### Установка на 1-м сервере
![](./assets/1vm-unicchat-install-scheme.jpg "Архитектура установки на 1-м сервере")

## Шаг 1. Подготовка окружения

#### Требования к конфигурации до 50 пользователей. Приложение и БД устанавливаются на 1-й виртуальной машине

##### Конфигурация виртуальной машины
```
CPU 4 cores 1.7ghz, с набором инструкций FMA3, SSE4.2, AVX 2.0;
RAM 16 Gb;
250 Gb HDD\SSD;
```
Для ОС Ubuntu 20+ предлагаем воспользоваться нашими краткими инструкциями. Для других ОС воспользуйтесь инструкциями, размещенными в сети Интернет.

* Установить docker и docker-compose  https://docs.docker.com/engine/install/ubuntu/
* Установить nginx
```shell
sudo apt install nginx
```
Установить certbot и плагин python3-certbot-nginx
```shell
sudo apt install certbot python3-certbot-nginx
```
Установить git
```shell
apt-get install git
```


## Шаг 2. Клонирование репозитория
1. Выполните на сервере:
   ```shell
   git clone https://github.com/unicommorg/unicchat.git
   ```

## Шаг 4. Проверка версии MongoDB
1. На виртуальной машине выполните команду:
   ```shell
   grep avx /proc/cpuinfo
   ```
   или аналогичную для вашей ОС.
2. Если в ответе вы не видите AVX, то в файле `./single_server_install/unicchat.yml` в строке `image: docker.io/bitnami/mongodb:${MONGODB_VERSION:-4.4}` убедитесь, что указана версия MongoDB 4.4.
3. Если AVX поддерживается (в ответе есть строки с поддержкой AVX), то можете поставить версию от 5 и выше.

## Шаг 5. Настройка HTTPS
1. Ниже примеры для app.unic.chat, поменяйте их для своего доменного имени.
2. Получите SSL-сертификат для домена `app.unic.chat`, замените на ваше доменное имя:
   ```shell
   sudo certbot --nginx -d app.unic.chat 
   ```
или
   ```shell
   sudo certbot --certonly -d app.unic.chat 
   ```
4. Создайте файл конфигурации Nginx для UnicChat, например, `/etc/nginx/sites-available/app.unic.chat`.
5. Скопируйте содержимое конфигурации из директории ./nginx в `/etc/nginx/sites-available/app.unic.chat`
6. Переместите файл options-ssl-nginx.conf из директории ./nginx в /etc/letsencrypt/ .

Сгенерируйте ssl-dhparams.pem

``` shell
sudo openssl dhparam -out /etc/letsencrypt/ssl-dhparams.pem 2048
```

6. Замените все вхождения app.unic.chat в конфигурации на ваше доменное имя
``` shell  
  sed -i 's/app.unic.chat/new_name/g' app.unic.chat
```
7. Переименуйте файл app.unic.chat на ваше доменное имя
   
8.  Активируйте конфигурацию:
   ```shell
   sudo ln -s /etc/nginx/sites-available/app.unic.chat /etc/nginx/sites-enabled/app.unic.chat
   sudo nginx -t
   sudo systemctl reload nginx
   ```
9. Отключите конфигурацию nginx  по умолчанию
``` shell
sudo rm /etc/nginx/sites-enabled/default
```


## Шаг 7. Запуск UnicChat
1. Выполните авторизацию в Docker для скачивания образов:
   ```shell
   sudo docker login \
     --username oauth \
     --password y0_AgAAAAB3muX6AATuwQAAAAEawLLRAAB9TQHeGyxGPZXkjVDHF1ZNJcV8UQ \
     cr.yandex
   ```
2. Перейдите в каталог `./single_server_install`:
   ```shell
   cd single_server_install
   ```
3. Запустите сервер, выполнив команду:
   ```shell
   docker compose -f unicchat.yml up -d
   ```
4. Дождитесь загрузки образов компонент, это может занять некоторое время. После загрузки компоненты запустятся автоматически.
5. Успешный запуск компонент будет отображаться в терминале:
   ![](./assets/server-started.png "Пример отображения запуска компонент")


## Шаг 8. Обновление настроек MongoDB
1. Подключитесь к контейнеру MongoDB с использованием root-учетной записи:
   ```shell
   docker exec -it unic.chat.db.mongo mongosh -u root -p rootpassword
   ```
2. Перейдите в базу данных `dbuc1`:
   ```javascript
   use dbuc1
   ```
3. Выполните команды для обновления настроек `Site_Url`:
   ```javascript
   db.rocketchat_settings.updateOne({"_id":"Site_Url"},{"$set":{"value":"https://app.unic.chat"}})
   db.rocketchat_settings.updateOne({"_id":"Site_Url"},{"$set":{"packageValue":"https://app.unic.chat"}})
   ```
4. Выйдите из MongoDB:
   ```shell
   exit
   ```
5. UnicChat будет доступен по адресу `https://app.unic.chat`.
## Шаг 9. Создание пользователя-администратора
1. При первом запуске откроется форма создания администратора:
   ![](./assets/form-setup-wizard.png "Форма создания администратора")
   * `Organization ID` - Идентификатор вашей организации, используется для подключения к push-серверу. Для получения ID необходимо написать запрос с указанием значения в Organization Name на почту support@unic.chat;
   * `Full name` - Имя пользователя, которое будет отображаться в чате;
   * `Username` - Логин пользователя, который вы будете указывать для авторизации;
   * `Email` - Действующая почта, используется для восстановления доступа;
   * `Password` - Пароль вашего пользователя;
   * `Confirm your password` - Подтверждение пароля;
2. После создания пользователя авторизуйтесь в веб-интерфейсе с использованием ранее указанных параметров.
3. Для включения пушей перейдите в раздел Администрирование - Push. Включите использование шлюза и укажите адрес шлюза `https://push1.unic.chat`.
4. Перейдите в раздел Администрирование - Organization, убедитесь, что поля заполнены в соответствии с п.1.
5. Настройка завершена.

## Шаг 10. Карта сетевых взаимодействий сервера

#### Входящие соединения на стороне сервера UnicChat:
Открыть порты:
- 8080/TCP - по умолчанию, сервер запускается на 8080 порту (для внутреннего проксирования через Nginx);
- 8081/TCP - для сервиса `uc.score`;
- 443/TCP - для HTTPS-соединений через Nginx;
- 80/TCP - для перенаправления HTTP-запросов на HTTPS;

#### Исходящие соединения на стороне сервера UnicChat:
* Открыть доступ для Push-шлюза:
  * 443/TCP, на хост `push1.unic.chat`;
* Открыть доступ для ВКС-сервера:
  * 443/TCP, на хост `lk-yc.unic.chat`;
  * 7880/TCP, 7881/TCP, 7882/UDP;
  * 5349/TCP, 3478/UDP;
  * (50000 - 60000)/UDP (диапазон этих портов может быть изменён при развертывании лицензионной версии непосредственно владельцем лицензии);
* Открыть доступ до внутренних ресурсов: LDAP, SMTP, DNS при необходимости использования этого функционала.

## Частые проблемы при установке
Раздел в наполнении.

## Клиентские приложения
* [Репозитории клиентских приложений]
* Android: (https://play.google.com/store/apps/details?id=pro.unicomm.unic.chat&pcampaignid=web_share)
* iOS: (https://apps.apple.com/ru/app/unicchat/id1665533885)
* Desktop: (https://github.com/unicommorg/unic.chat.desktop.releases/releases)
