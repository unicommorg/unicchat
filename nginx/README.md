# Nginx + Let's Encrypt SSL

Простое решение для настройки nginx с SSL сертификатами через Let's Encrypt.

## Структура

```
nginx/
├── docker-compose.yml          # Docker Compose конфигурация
├── generate_ssl.sh             # Скрипт для генерации SSL
├── config/
│   ├── nginx.conf.template     # Шаблон конфигурации nginx
│   └── nginx.conf              # Активная конфигурация (генерируется автоматически)
├── ssl/                        # SSL сертификаты
└── www/                        # Challenge файлы для Let's Encrypt
```

## Использование

### 1. Настройте домен

Убедитесь что в `domain.usr.txt` указаны:
```
DOMAIN=yourdomain.com
EMAIL=your@email.com
```

### 2. Настройте upstream в конфигурации nginx

**ВАЖНО:** Сделайте это ПЕРЕД генерацией SSL!

Отредактируйте `config/nginx.conf.template` и измените `upstream internal` на адрес вашего сервиса:

```nginx
upstream internal {
    server 127.0.0.1:8080;  # Или ваш сервер/контейнер
}
```

Также измените `config/nginx-init.conf` (должно совпадать с основным шаблоном).

### 3. Сгенерируйте SSL сертификат и запустите nginx

```bash
sudo ./nginx/generate_ssl.sh
```

Выберите опцию **[1] Генерация SSL сертификата**

Скрипт автоматически выполнит в правильном порядке:
1. ✅ Остановит nginx (если запущен) - освободит порт 80
2. ✅ Получит SSL сертификат через Let's Encrypt (standalone режим)
3. ✅ Обновит конфигурацию nginx с вашим доменом
4. ✅ Запустит nginx с SSL сертификатом

### 4. Альтернативно: используйте меню

```bash
sudo ./nginx/generate_ssl.sh
```

Меню позволяет:
- Генерировать SSL сертификат
- Генерировать/обновлять конфигурацию nginx
- Запускать/останавливать/перезапускать nginx
- Просматривать статус и логи

## Порядок работы

**Правильный порядок:**
1. Настройте upstream в шаблонах конфигурации
2. Сгенерируйте SSL сертификат (опция 1 в меню)
3. Скрипт автоматически обновит конфигурацию и запустит nginx

**Или вручную:**
1. Настройте upstream
2. Генерируйте SSL сертификат (опция 1)
3. Генерируйте конфигурацию (опция 2)
4. Запустите nginx (опция 3)

## Автоматическое обновление

Certbot автоматически обновляет сертификаты каждые 12 часов.

## Troubleshooting

### Порт 80 не доступен

```bash
# Откройте порты в firewall
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

### Проверка работы

```bash
# Проверить логи nginx
docker logs unicchat.nginx

# Проверить сертификаты
ls -la ssl/live/yourdomain.com/

# Проверить доступность
curl https://yourdomain.com
```

